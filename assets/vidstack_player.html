<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.jsdelivr.net/npm/hls.js@~1/dist/hls.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "p2p-media-loader-core": "https://cdn.jsdelivr.net/npm/p2p-media-loader-core@^1/dist/p2p-media-loader-core.es.min.js",
          "p2p-media-loader-hlsjs": "https://cdn.jsdelivr.net/npm/p2p-media-loader-hlsjs@^1/dist/p2p-media-loader-hlsjs.es.min.js"
        }
      }
    </script>

    <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />

    <script src="https://cdn.vidstack.io/player" type="module"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100vw;
        background-color: transparent;
      }
    </style>

    <script type="module">
      import { HlsJsP2PEngine } from "p2p-media-loader-hlsjs";

      let hlsP2PEngine;

      function destroyP2P() {
        if (!hlsP2PEngine) return;

        hlsP2PEngine.destroy();
        hlsP2PEngine = null;
      }

      function updateP2PState(isDisabled) {
        if (!hlsP2PEngine) return;

        const isP2PDisabled =
          hlsP2PEngine.getConfig().core.mainStream.isP2PDisabled;

        if (isP2PDisabled === isDisabled) return;

        hlsP2PEngine.applyDynamicConfig({
          core: {
            isP2PDisabled: isDisabled,
          },
        });
      }

      window.destroyP2P = destroyP2P;
      window.updateP2PState = updateP2PState;

      let httpDownloadedBytes = 0;
      let p2pDownloadedBytes = 0;
      let p2pUploadedBytes = 0;

      function postDownloadStats(downloadedBytes, downloadSource) {
        const stats = {
          downloadedBytes,
          downloadSource,
        };
        onChunkDownloaded.postMessage(JSON.stringify(stats));
      }

      function postUploadStats(uploadedBytes) {
        const stats = {
          uploadedBytes,
        };
        onChunkUploaded.postMessage(JSON.stringify(stats));
      }

      const player = document.querySelector("media-player");

      player.addEventListener("provider-change", (event) => {
        const provider = event.detail;

        if (provider?.type === "hls") {
          const HlsWithP2P = HlsJsP2PEngine.injectMixin(window.Hls);
          provider.library = HlsWithP2P;

          provider.config = {
            p2p: {
              onHlsJsCreated: (hls) => {
                hlsP2PEngine = hls.p2pEngine;

                hls.p2pEngine.addEventListener("onPeerConnect", (params) => {
                  onPeerConnect.postMessage(JSON.stringify(params));
                });

                hls.p2pEngine.addEventListener("onPeerClose", (params) => {
                  onPeerClose.postMessage(JSON.stringify(params));
                });

                hls.p2pEngine.addEventListener(
                  "onChunkDownloaded",
                  (bytesLength, downloadSource) => {
                    if (downloadSource === "http") {
                      httpDownloadedBytes += bytesLength;
                    } else if (downloadSource === "p2p") {
                      p2pDownloadedBytes += bytesLength;
                    }
                  }
                );

                hls.p2pEngine.addEventListener(
                  "onChunkUploaded",
                  (bytesLength) => {
                    p2pUploadedBytes += bytesLength;
                  }
                );
              },
            },
          };
        }
      });

      setInterval(() => {
        if (p2pUploadedBytes > 0) {
          postUploadStats(p2pUploadedBytes);
          p2pUploadedBytes = 0;
        }

        if (httpDownloadedBytes > 0) {
          postDownloadStats(httpDownloadedBytes, "http");
          httpDownloadedBytes = 0;
        }

        if (p2pDownloadedBytes > 0) {
          postDownloadStats(p2pDownloadedBytes, "p2p");
          p2pDownloadedBytes = 0;
        }
      }, 1000);
    </script>
  </head>

  <body>
    <div>
      <media-player
        playsInline
        src="https://cph-p2p-msl.akamaized.net//hls/live/2000341/test/master.m3u8"
      >
        <media-provider></media-provider>
        <media-video-layout></media-video-layout>
      </media-player>
    </div>
  </body>
</html>
